#!/usr/bin/env bash

main() {
  ! command -v nvim >/dev/null && {
    #echo "default editor"
    "$EDITOR" "$@"
    return
  }

  __server="${HOME}/nvim.pipe"

  # remote-expr outputs to /dev/stderr for some reason
  __existing=$(nvim \
    --server "$__server" \
    --remote-expr "execute('echo v:servername')" \
    2>&1)

  [ "$__existing" != "$__server" ] && {
    file="$1"
    if [ -z "$file" ]; then
      #echo "New server with empty file"
      nvim --listen "$__server" +enew
      return
    fi
  }

  typeset -a files=()
  for file in "$@"; do
    # don't prepend PWD for absolute paths
    case "$file" in
      /*) ;;
      *) file="${PWD}/${file}" ;;
    esac
    files+=("$file")
  done

  [ "$__existing" != "$__server" ] && {
    #echo "starting server at ${__server} with ${files[*]}"
    nvim --listen "$__server" "${files[@]}"
    return
  }

  #echo "using server at ${__server} with ${file[*]}"
  nvim --server "$__server" --remote-silent "${files[@]}"
}

main "$@"
