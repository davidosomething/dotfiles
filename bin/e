#!/usr/bin/env bash

__server="${XDG_STATE_HOME}/nvim/nvim.sock"

ctrl_c() {
  echo "Detected CTRL-C, removing nvim.sock"
  rm "$__server"

  local orphans
  orphans=$(
    # shellcheck disable=2009
    ps ux | grep -v grep | grep language-server
  )
  [[ -n $orphans ]] &&
    echo "Possible orphan language server processes:"
  echo "$orphans"
}

main() {
  ! command -v nvim >/dev/null && {
    [[ "$E_DEBUG" != "" ]] && echo "default editor"
    "$EDITOR" "$@"
    return
  }

  local first="$1"

  local existing
  local running
  running=$(pgrep nvim)

  # invalid nvim.sock
  if [ -z "$running" ]; then
    [[ "$E_DEBUG" != "" ]] && echo "Not running"
    [ -e "$__server" ] && {
      [[ "$E_DEBUG" != "" ]] && echo "Removing dead nvim.sock"
      rm "$__server"
    }
  else
    # remote-expr outputs to /dev/stderr for some reason
    # 0.9.0 needs headless https://github.com/neovim/neovim/issues/22970
    existing=$(nvim \
      --headless \
      --server "$__server" \
      --remote-expr "execute('echo v:servername')" \
      2>&1)
    [[ "$E_DEBUG" != "" ]] && echo "Found running $existing"
  fi

  # New server, empty
  [ "$existing" != "$__server" ] && [ -z "$first" ] && {
    [[ "$E_DEBUG" != "" ]] && echo "new server ${__server} with empty file"
    nvim --listen "$__server" +enew
    return
  }

  typeset -a files=()
  for file in "$@"; do
    # don't prepend PWD for absolute paths
    case "$file" in
    /*) ;;
    *) file="${PWD}/${file}" ;;
    esac
    files+=("$file")
  done

  # New server with files
  [ "$existing" != "$__server" ] && {
    [[ "$E_DEBUG" != "" ]] && echo "new server ${__server} with ${files[*]}"
    nvim --listen "$__server" "${files[@]}"
    return
  }

  # ==========================================================================
  # use existing server
  # ==========================================================================

  # 0.9.0 needs headless https://github.com/neovim/neovim/issues/22970
  nvim \
    --headless \
    --server "$__server" \
    --remote-expr "execute('DKOExternal')"

  if [ -z "$first" ]; then
    [[ "$E_DEBUG" != "" ]] && echo "no file given, surface existing server"
    nvim --server "$__server" --remote-send '<C-\><C-N><Cmd>e<CR>'
    return
  fi

  [[ "$E_DEBUG" != "" ]] && echo "use server ${__server} with ${file[*]}"
  nvim --server "$__server" --remote-silent "${files[@]}"
}

trap ctrl_c INT
main "$@"
