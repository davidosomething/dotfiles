#!/usr/bin/env bash

main() {
  ! command -v nvim >/dev/null && {
    #echo "default editor"
    "$EDITOR" "$@"
    return
  }

  __server="${HOME}/nvim.pipe"

  # remote-expr outputs to /dev/stderr for some reason
  __existing=$(nvim \
    --server "$__server" \
    --remote-expr "execute('echo v:servername')" \
    2>&1)

  local first="$1"
  [ "$__existing" != "$__server" ] && [ -z "$first" ] && {
    #echo "new server ${__server} with empty file"
    nvim --listen "$__server" +enew
    return
  }

  typeset -a files=()
  for file in "$@"; do
    # don't prepend PWD for absolute paths
    case "$file" in
      /*) ;;
      *) file="${PWD}/${file}" ;;
    esac
    files+=("$file")
  done

  [ "$__existing" != "$__server" ] && {
    #echo "new server ${__server} with ${files[*]}"
    nvim --listen "$__server" "${files[@]}"
    return
  }

  # ==========================================================================
  # use existing server
  # ==========================================================================

  if [ -z "$first" ]; then
    #echo "no file given, surface existing server"
    nvim --server "$__server" --remote-send '<C-\><C-N>:e<CR>'
    return
  fi

  #echo "use server ${__server} with ${file[*]}"
  nvim --server "$__server" --remote-silent "${files[@]}"
}

main "$@"
